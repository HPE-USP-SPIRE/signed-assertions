# Proof of Concept scenarios

This Proof of Concept simulates a banking application. The business logic says that the end user must use an OKTA OAuth token to log in Subject_wl (front-end). The subject_wl will exchange this token for a more restrictive one (SVID-NG), generated by Asserting_wl. The SVID-NG is then used in authorization mechanisms to access end user data. More details about asserting-wl can be found in its readme (link). The base use case to the developed scenarios is depicted in Figure 1.

![Basic Scenario](https://github.com/HPE-USP-SPIRE/signed-assertions/blob/main/doc/basicscenario.jpg)

In this scenario, each component is a workload with a SPIFFE-ID running in a Docker container. The Local IdP (asserting-wl) is a trusted component allowed to mint new SVID-NG tokens. When the front-end application requires to access the end-user data, it stablishes a SPIRE mTLS connection with Local IdP, sending the end-user OAuth token. The Local IdP, by its side, receives the OAuth token, mint a SVID-NG and sign it with a private key sending back to front end.

The Middle tiers simulates generic cloud application components (e.g. load balancer), to exemplify the SVID-NG transitivity. In this PoC, when receive requests that uses SVID-NG, it first validate its expiration and signature. After that, the SVID-NG go through all middle tiers until reaches the target-wl where a full validation is performed, before authorizing the access to user data. First step is the validation of the SVID-NG signature(s) and mandatory claims. Then, target-wl contacts asserting-wl introspect endpoint to retrieve a ZKP of a valid OAuth token behind given SVID-NG. Finally, target-wl validates received proof and, if all validations are successful, return user data.

During the nested token scheme development, three test scenarios were created to apply and evaluate each of the different constructions. Each subdir contains a specific use case. The SVID-NG was the first use case, containing the SVID-NG and local IdP specification and development. Then, this use case was extended, implementing the ID-mode and anonymous-mode.  

## ID-mode
The workloads uses SPIRE SVID private key to sign the tokens. The user OAuth token is exchanged for an ECDSA assertion, generated by asserting-wl (IdP). Each workload in the application adds new issuer claim with its own public key and audience with next hop public key. and its own signature.  
Together with the token, the workload forward also its trust bundle, allowing for identification and validation offline.

## Anonymous mode
The workloads dont use any IdP. This model do not offer identification of the workloads, but takes advantage of this by using a signature concatenation model that allows for token size reduction and fast validation execution times.
The resulting token is smaller than in ID-mode, as it remove part of the signatures to use as private key. Also, there is no need to send certificates along with the token.

## SVID-NG
The basic model developed in Phase 1 of the project. In this scenario, asserting wl mint a token that allows the delegation of user rights to a workload. The objective of this token (a.k.a. SVID-NG) is to grant that the calling workload have the sufficient rights to access the desired resource. 


# Requirements (tested)

- GNU/Linux (Debian 11)
- Docker (20.10.11)
- Go (1.16.9)

# Installation

Each scenario follows the same structure, being the difference the token scheme adopted. 

To run PoC scenarios is necessary to create an OKTA user account and an OIDC application. More details the tutorial can be found in https://github.com/HPE-USP-SPIRE/signed-assertions/blob/main/doc/okta-tutorial.md

For a complete manual installation of dependencies, follow Step by Step.md guide.

After downloading the repository, first change permissions on all scripts to run as executables:

```bash
sudo chmod +x -R *.sh && sudo chmod +x lib/*.sh
```

1. **DO NOT** run any script with extra privileges with sudo. The proper locations to run as sudo are written on each script.

2. Run **requirements.sh** if you do not have all required packages installed.

3. Before you run **installation.sh**, it is necessary to put your data in the **config** file:

   - If you **DO NOT** want to install SPIRE or Docker (probably because you already have it), change values to **TRUE**.
   - Put your OKTA credentials (client ID, client secret) 
   - Change the IP address to the machine that will run the application. Change each line accordingly.

# How to use

To config the environemnt according to config file, initialize SPIRE (agent and server) and all docker containers (workloads):

```
chmod +x init
./init
```

<br>
To kill SPIRE and the containers

```
./kill
```

_Disclaimer 1: init also runs kill, and both kill all the containers running in the machine!_

_Disclaimer 2: you might need to allow the scripts to run, with `chmod +x init kill`._
<br>
<br>


# References

https://developer.okta.com/authentication-guide/implementing-authentication/auth-code#1-setting-up-your-application
