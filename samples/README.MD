# Proof of Concept scenarios

This Proof of Concept simulates a banking application. The business logic says that the end user must use an OKTA OAuth token to log in Subject_wl (front-end). The subject_wl will exchange this token for a more restrictive one (SVID-NG), generated by Asserting_wl. The SVID-NG is then used in authorization mechanisms to access end user data. More details about asserting-wl can be found in its readme (link). The base use case to the developed scenarios is depicted in Figure 1.

![Basic Scenario](https://github.com/HPE-USP-SPIRE/signed-assertions/blob/main/doc/basicscenario.jpg)

In this scenario, each component is a workload with a SPIFFE-ID running in a Docker container. The Local IdP (asserting-wl) is a trusted component allowed to mint new SVID-NG tokens. When the front-end application requires to access the end-user data, it stablishes a SPIRE mTLS connection with Local IdP, sending the end-user OAuth token. The Local IdP, by its side, receives the OAuth token, mint a SVID-NG and sign it with a private key sending back to front end.

The Middle tiers simulates generic cloud application components (e.g. load balancer), to exemplify the SVID-NG transitivity. In this PoC, when receive requests that uses SVID-NG, it first validate its expiration and signature. After that, the SVID-NG go through all middle tiers until reaches the target-wl where a full validation is performed, before authorizing the access to user data. First step is the validation of the SVID-NG signature(s) and mandatory claims. Then, target-wl contacts asserting-wl introspect endpoint to retrieve a ZKP of a valid OAuth token behind given SVID-NG. Finally, target-wl validates received proof and, if all validations are successful, return user data.

During the nested token scheme development, three test scenarios were created to apply and evaluate each of the different constructions. Each subdir contains a specific use case. The SVID-NG was the first use case, containing the SVID-NG and local IdP specification and development. Then, this use case was extended, implementing the ID-mode and anonymous-mode.  

You can find more detailed information inside each of the sample's README file, and also on the [general doc](../doc/ProofOfConcept.md)

## ID-mode
The workloads uses SPIRE SVID private key to sign the tokens. The user OAuth token is exchanged for an ECDSA assertion, generated by asserting-wl (IdP). Each workload in the application adds new issuer claim with its own public key and audience with next hop public key. and its own signature.  
Together with the token, the workload forward also its trust bundle, allowing for identification and validation offline.

## Anonymous mode
The workloads dont use any IdP. This model do not offer identification of the workloads, but takes advantage of this by using a signature concatenation model that allows for token size reduction and fast validation execution times.
The resulting token is smaller than in ID-mode, as it remove part of the signatures to use as private key. Also, there is no need to send certificates along with the token.

## SVID-NG
The basic model developed in Phase 1 of the project. In this scenario, asserting wl mint a token that allows the delegation of user rights to a workload. The objective of this token (a.k.a. SVID-NG) is to grant that the calling workload have the sufficient rights to access the desired resource. 


# Requirements (tested)

- GNU/Linux (Debian 11)
- Docker (20.10.11)
- Go (1.16.9)

# Setup Guide

## Installing Requirements Automatically

All of the dependencies can be installed using the `SVID-NG/installation.sh` script. Those that are already installed in your machine won't be reinstalled. Run:

```
cd SVID-NG 
./installation.sh
```

**Important notes regarding the `installation.sh` script**:

- Reboot your machine if you didn't have Docker installed
- Docker installation is only supported on Debian and Ubuntu. Please install it manually if you use another Operating System
- SPIRE installation is only supported on Linux
- APT packages installation are only supported on debian-based distributions
- Latest SPIRE and Docker will be downloaded. If you run into problems later on, consider purging the downloaded dependencies and downloading the aforementioned versions instead

## Installing Requirements Manually

If you don't want to use the installation script, you may install the requirements manually: 

1. Install SPIRE (sudo required)
```
cd /opt
git clone https://github.com/spiffe/spire.git
cd /opt/spire
make build
sed -i 's/secure_path=\"/secure_path=\"\/opt\/spire\/bin:/' /etc/sudoers
source ~/.bashrc
```

2. Install Docker (sudo required)
  * Use [this link](https://docs.docker.com/engine/install/ubuntu/) for Ubuntu distribution
  * Use [this link](https://docs.docker.com/engine/install/debian/) for Debian distribution

3. Extra Docker configuration

Add user to Docker group (recommended): 

```
sudo usermod -aG docker $USER
su - $USER
```

If you didn't install SPIRE via the `installation.sh` script, you need to allow docker and k8s to fetch SVIDs. Add the following code to `/opt/spire/conf/agent/agent.conf`, inside the "plugin" brackets, after the last WorkloadAttestor:

```
WorkloadAttestor "k8s" {
   plugin_data {
      kubelet_read_only_port = "10255"
   }
}

WorkloadAttestor "docker" { plugin_data { } }
```


## Configure your OKTA application

First of all fetch yout private IP. On Linux, check for the 192.168... pattern running:

```
ip a
```

Take note of that IP. You will use it to configure the application. Notice that it might change when you use another network or reboot your computer, so if you don't set it as static you might need to reconfigure the application in the future.

Okta is an identity provider, which is used in this PoC to create and send an oAuth token to the frontend (Subject Workload). You will need to register to their platform, creating a **developer account** at https://developer.okta.com/signup/.

When logged in:

1. Go to Applications -> Application in the menu
2. Click on "Create App Integration"
3. Choose "OIDC" as the sign-in method and "Web Application" as the application type
4. Under "Client acting on behalf of a user", check "Authorization Code" and "Implicit (hybrid)". Let the wildcards checkbox disabled.
5. Under "Sign-in redirect URIs", remove whatever is in there and add: http://IP:8080/callback, where IP must be tour private IP
6. Under "Controlled Access", check "Allow everyone in your organization to access"

# References

https://developer.okta.com/authentication-guide/implementing-authentication/auth-code#1-setting-up-your-application


# Common Issues 

### Running the project in a VM 

To be able to correctly run the project in a VM, it must be configured to attach to a bridged adapter. This setting is usually found under the Network Settings.
