# Transitive Identity & Embedded Claims

## Proof of Concept

This Proof of Concept simulates a banking application. The business logic says that the end user must use an OKTA OAuth token to log in to the Subject Workload (frontend process). The subject_wl will exchange this token for a more restrictive one (DA-SVID), generated by the Asserting_wl. The DA-SVID is then used in authorization mechanisms to access end user data.

In this scenario, each component is a workload with a SPIFFE-ID running in a Docker container. The Asserting Workload is a trusted component allowed to mint new DA-SVID tokens. When the front-end application requires to access the end-user data, it stablishes a SPIRE mTLS connection with Asserting Workload, sending an OAuth token to the end-user. The Asserting Workload, receives the OAuth token, mint a DA-SVID (claims described at ... ref doc...) and sign it with a private key (can be its own SVID or another specific key), finally sendingit back to the Subject Workload.

The Middle tiers simulates generic cloud application components (e.g. load balancer), to exemplify the DA-SVID transitivity. In this PoC, when requests that uses DA-SVID are received, the expiration and signature are validated. After that, the DA-SVID go through all middle tiers, that uses Asserting Workload introspect endpoint to validate the DA-SVID. The valid requests are send to Target Workload.

When Target Workload receives a request with DA-SVID, it check its expiration and signature. If valid, Target Workload parses its claims and verifies if the DA-SVID subject claim is allowed to use DA-SVID. Then, **TW** extract **dpr claim** and perform a database search for that user, returning the user balance or an error message.

<br><br>

# How it works

Asserting Workload is the main component that is responsible for Oauth token validation and DA-SVID minting. To perform its tasks, Asserting WL exposes an API with the necessary endpoints described bellow. All API responses are in JSON format.

To access the API, clients must stablish a mTLS connection with Asserting Workload using its SVID. Asserting workload accepts any connection originated from its trust domain, and clients should accept connections only from specific predefined SPIFFE-IDs (Asserting Workload).

When connected, clients can access /keys, /mint and /introspect endpoints.

<br>

### /keys

This endpoint does not require any parameter, and returns the public key set necessary to validate DA-SVIDs.

<br>

### /mint

Require a OKTA or Google OAuth token as _AccessToken_ parameter.

When a mint call is received, the Asserting Workload validate the OAuth token received. If the token is valid, it fetchs the SPIFFE-ID from the current mTLS session and uses it as DA-SVID subject claim. Asserting Workload also fetchs its own SPIFFE-ID and use it as DA-SVID issuer claim.

After DA-SVID claims generation, the token is signed with Asserting Workload private key, that could be its SVID or another specific key. The current implementation uses a specific key, localized in ./keys.

In the end, the Asserting Workload sends to client Oauth token expiration and signature validation results and the generated DA-SVID.

<br>

### /introspect

Requires a DA-SVID as parameter.

This endpoint return the DA-SVID original claims and a Zero Knowledge Proof (ZKP) granting that a valid OAuth token was used to generate that DA-SVID.

<br><br>

# Using the POC

</br>

## Setup your Environment

If you haven't already, follow the Setup Guide, on [/samples/README](../README.MD) 

After doing that, manually alter the `.cfg` file inside each workload folder accordingly:

- CLIENT_ID and CLIENT_SECRET: found in your okta application
- OKTA_DEVELOPER_CODE: a 7 number ID found in the URL of you okta dashboard (between dev- and -admin)
- HOST_IP: the IP set under "Sign-in redirect URIs" in your okta application
- WORKLOADIP: for each one of the workloads, configure it's IP with your host IP followed by a port (IP:PORT)

Here is a sample configuration:

```
CLIENT_ID=0oo643ull1KZl5yVe5d7
CLIENT_SECRET=yl5_6mIaTu5e1p5E70NazdFKNZ6bOhhWAzerdCOVc
OKTA_DEVELOPER_CODE=1234567
HOSTIP=192.168.0.100
ASSERTINGWLIP=192.168.0.100:8443
MIDDLETIERIP=192.168.0.100:8445
MIDDLE_TIER2_IP=192.168.0.100:8446
MIDDLE_TIER3_IP=192.168.0.100:8447
MIDDLE_TIER4_IP=192.168.0.100:8448
MIDDLE_TIER5_IP=192.168.0.100:8449
TARGETWLIP=192.168.0.100:8444
```

## Run the Application

To run the application, simply use the command `docker-compose up --build`

After running it, open your browser on localhost:8080 and see if the application is working correctly

</br>

**Important**:

- SPIRE will keep running in background. Use `./kill` to stop the application. Notice that it will kill all the docker conatiners running in your machine
- Check the output for potential network errors during the download and preparation of the docker images
- Always check if your IP is correctly set in OKTA and in `.cfg`

