# Delegated Assertions SVID (DA-SVID)

## Overview

This Proof of Concept simulates a banking application. The business logic states that the end user must use an OKTA OAuth token to log in Subject_wl (front-end). The subject_wl will exchange this token for a more restrictive one (DA-SVID), generated by Asserting_wl. The DA-SVID is then used in authorization mechanisms to access end user data.

![Basic Scenario](https://github.com/HPE-USP-SPIRE/signed-assertions/blob/main/doc/basicscenario.jpg)

In this scenario, each component is a workload with a SPIFFE-ID running in a Docker container. The Local Identity Provider (IdP), which is the asserting-wl, is a trusted component allowed to mint new DA-SVID tokens. When the front-end application requires to access the end-user data, it stablishes a SPIRE mTLS connection with the Local IdP, sending the end-user OAuth token. The Local IdP, in turn, receives the OAuth token, mints a DA-SVID and sign it with a private key, sending it back to the front-end.

The Middle tiers simulates generic cloud application components (e.g. load balancer), to exemplify the DA-SVID transitivity. The DA-SVID go through all middle tiers until it reaches the target-wl, where a full validation (which includes checking the expiration and signature) is performed before authorizing the access to user data. The first step is the validation of the DA-SVID signature(s) and mandatory claims. Finally, the target-wl may contact the asserting-wl introspect endpoint to retrieve a Zero-Knowledge Proof (ZKP) of a valid OAuth token behind a given DA-SVID. In this case, the target-wl validates received proof and, if all validations are successful, it carries on with the request (add balance to user account, or retrieve user's balance).

## API

Asserting Workload is the main component that is responsible for Oauth token validation and DA-SVID minting. To perform its tasks, Asserting WL exposes an API with the necessary endpoints described bellow. All API responses are in JSON format.

To access the API, clients must stablish a mTLS connection with Asserting Workload using its SVID. Asserting workload accepts any connection originated from its trust domain, and clients should accept connections only from specific predefined SPIFFE-IDs (Asserting Workload).

When connected, clients can access /keys, /mint and /introspect endpoints.

### /keys

This endpoint does not require any parameter, and returns the public key set necessary to validate DA-SVIDs.

### /mint

| Parameter       | Type   | Required | Description                                                         |
| --------------- | ------ | -------- | ------------------------------------------------------------------- |
| `<AccessToken>` | string | yes      | Mint a new DA-SVID based in OKTA OAuth token received as parameter. |

When a mint call is received, the Asserting Workload validate the OAuth token received. If the token is valid, it fetchs the SPIFFE-ID from the current mTLS session and uses it as DA-SVID subject claim. Asserting Workload also fetchs its own SPIFFE-ID and use it as DA-SVID issuer claim.

After DA-SVID claims generation, the token is signed with Asserting Workload private key, that could be its SVID or another specific key. The current implementation uses a specific key, localized in ./keys.

In the end, the Asserting Workload sends to client Oauth token expiration and signature validation results and the generated DA-SVID.

### /introspect

| Parameter   | Type   | Required | Description                            |
| ----------- | ------ | -------- | -------------------------------------- |
| `<DA-SVID>` | string | yes      | Return OAuth token ZKP, given DA-SVID. |

This endpoint return the DA-SVID original claims and a Zero Knowledge Proof (ZKP) granting that a valid OAuth token was used to generate that DA-SVID.

### /validate

| Parameter   | Type   | Required | Description              |
| ----------- | ------ | -------- | ------------------------ |
| `<DA-SVID>` | string | yes      | DA-SVID to be validated. |

This endpoint return the result of expiration time and signature validation of given DA-SVID.
