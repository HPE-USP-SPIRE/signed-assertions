# Transitive Identity & Embedded Claims

## Proof of Concept

This Proof of Concept simulates a banking application. The business logic says that the end user must use an OKTA OAuth token to log in to the Subject Workload (frontend process). The subject_wl will exchange this token for a more restrictive one (DA-SVID), generated by the Asserting_wl. The DA-SVID is then used in authorization mechanisms to access end user data.

In this scenario, each component is a workload with a SPIFFE-ID running in a Docker container. The Asserting Workload is a trusted component allowed to mint new DA-SVID tokens. When the front-end application requires to access the end-user data, it stablishes a SPIRE mTLS connection with Asserting Workload, sending an OAuth token to the end-user. The Asserting Workload, receives the OAuth token, mint a DA-SVID (claims described at ... ref doc...) and sign it with a private key (can be its own SVID or another specific key), finally sendingit back to the Subject Workload.

The Middle tiers simulates generic cloud application components (e.g. load balancer), to exemplify the DA-SVID transitivity. In this PoC, when requests that uses DA-SVID are received, the expiration and signature are validated. After that, the DA-SVID go through all middle tiers, that uses Asserting Workload introspect endpoint to validate the DA-SVID. The valid requests are send to Target Workload.

When Target Workload receives a request with DA-SVID, it check its expiration and signature. If valid, Target Workload parses its claims and verifies if the DA-SVID subject claim is allowed to use DA-SVID. Then, **TW** extract **dpr claim** and perform a database search for that user, returning the user balance or an error message.

<br><br>

# How it works

Asserting Workload is the main component that is responsible for Oauth token validation and DA-SVID minting. To perform its tasks, Asserting WL exposes an API with the necessary endpoints described bellow. All API responses are in JSON format.

To access the API, clients must stablish a mTLS connection with Asserting Workload using its SVID. Asserting workload accepts any connection originated from its trust domain, and clients should accept connections only from specific predefined SPIFFE-IDs (Asserting Workload).

When connected, clients can access /keys, /mint and /introspect endpoints.

<br>

### /keys

This endpoint does not require any parameter, and returns the public key set necessary to validate DA-SVIDs.

<br>

### /mint

Require a OKTA or Google OAuth token as _AccessToken_ parameter.

When a mint call is received, the Asserting Workload validate the OAuth token received. If the token is valid, it fetchs the SPIFFE-ID from the current mTLS session and uses it as DA-SVID subject claim. Asserting Workload also fetchs its own SPIFFE-ID and use it as DA-SVID issuer claim.

After DA-SVID claims generation, the token is signed with Asserting Workload private key, that could be its SVID or another specific key. The current implementation uses a specific key, localized in ./keys.

In the end, the Asserting Workload sends to client Oauth token expiration and signature validation results and the generated DA-SVID.

<br>

### /introspect

Requires a DA-SVID as parameter.

This endpoint return the DA-SVID original claims and a Zero Knowledge Proof (ZKP) granting that a valid OAuth token was used to generate that DA-SVID.

<br><br>

## Dependencies

- SPIRE (1.4.7)
- Docker Engine - Community Version: 20.10.11
- Debian APT packages: build-essential, curl, git, make

All of the dependencies can be installed using the `installation.sh` script. Those that are already installed in your machine won't be reinstalled. Run:

```
./installation.sh
```

**Important notes regarding the `installation.sh` script**:

- Reboot your machine if you didn't have Docker installed
- Docker installation is only supported on Debian and Ubuntu. Please install it manually if you use another Operating System
- SPIRE installation is only supported on Linux
- APT packages installation are only supported on debian-based distributions
- Latest SPIRE and Docker will be downloaded. If you run into problems later on, consider purging the downloaded dependencies and downloading the aforementioned versions instead

<br><br>

## Configuration

First of all fetch yout private IP. On Linux, check for the 192.168... pattern running:

```
ip a
```

Take note of that IP. You will use it to configure the application. Notice that it might change when you use another network or reboot your computer, so if you don't set it as static you might need to reconfigure the application in the future.

Okta is an identity provider, which is used in this PoC to create and send an oAuth token to the frontend (Subject Workload). You will need to register to their platform, creating a **developer account** at https://developer.okta.com/signup/.

When logged in:

1. Go to Applications -> Application in the menu
2. Click on "Create App Integration"
3. Choose "OIDC" as the sign-in method and "Web Application" as the application type
4. Under "Client acting on behalf of a user", check "Authorization Code" and "Implicit (hybrid)". Let the wildcards checkbox disabled.
5. Under "Sign-in redirect URIs", remove whatever is in there and add: http://IP:8080/callback, where IP must be tour private IP
6. Under "Controlled Access", check "Allow everyone in your organization to access"

Now open the general configuration file `.cfg`, and set accordingly:

- CLIENT_ID and CLIENT_SECRET: found in your okta application
- OKTA_DEVELOPER_CODE: a 7 number ID found in the URL of you okta dashboard (between dev- and -admin)
- HOST_IP: the IP set under "Sign-in redirect URIs" in your okta application

Here is a sample configuration:

```
CLIENT_ID=0oo643ull1KZl5yVe5d7
CLIENT_SECRET=yl5_6mIaTu5e1p5E70NazdFKNZ6bOhhWAzerdCOVc
OKTA_DEVELOPER_CODE=1234567
HOSTIP=192.168.0.100
```

Finally, **if you didn't install SPIRE via the `installation.sh` script**, you need to allow docker and k8s to fetch SVIDs. Add the following code to `/opt/spire/conf/agent/agent.conf`, inside the "plugin" brackets, after the last WorkloadAttestor:

```
WorkloadAttestor "k8s" {
   plugin_data {
      kubelet_read_only_port = "10255"
   }
}

WorkloadAttestor "docker" { plugin_data { } }
```

<br><br>

## Usage

After following the above steps, you just have to run:

```
./init
```

When you see that the terminal is available again (user@machine: ...), you can open `localhost:8080` on your browser and use the application.

**Important**:

- SPIRE will keep running in background. Use `./kill` to stop the application. Notice that it will kill all the docker conatiners running in your machine
- Check the output for potential network errors during the download and preparation of the docker images
- Always check if your IP is correctly set in OKTA and in `.cfg`

<br>

### Git

To update the local files (pull) and create a new branch:

```
./git-branch <branch_name>
```

To push directly to the branch you are currently in:

```
./git-push <message>
```

_Disclaimer: The push script already sets the configuration to the default one (blank), and then restores it after the push is done_
